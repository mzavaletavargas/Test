<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Profiling - Gustavo's Wiki</title>
  

  <link
    rel="shortcut icon"
    href="https://wiki.gustavozavaleta.com/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://wiki.gustavozavaleta.com/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://wiki.gustavozavaleta.com/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://wiki.gustavozavaleta.com/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
   
  
<meta name="description" content="Personal knowledge space">
<meta name="author" content="">

<link rel="canonical" href="https://wiki.gustavozavaleta.com/notes/257957a2-5699-47d2-b6d5-96d468443db7.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://wiki.gustavozavaleta.com/notes/257957a2-5699-47d2-b6d5-96d468443db7.html">
<meta property="og:description" content="Personal knowledge space">
<meta property="og:image" content="https://wiki.gustavozavaleta.comundefined">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://wiki.gustavozavaleta.com/notes/257957a2-5699-47d2-b6d5-96d468443db7.html">
<meta name="twitter:description" content="Personal knowledge space">
<meta name="twitter:image" content="https://wiki.gustavozavaleta.comundefined">


  <meta property="og:title" content="Profiling - Gustavo's Wiki" />
  <meta name="twitter:title" content="Profiling - Gustavo's Wiki" />
  
</head>



<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://wiki.gustavozavaleta.com" class="site-title lh-tight">
  Gustavo's Wiki

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        ðŸŒ± with ðŸ’• using <a href="https://www.dendron.so/"> Dendron ðŸŒ² </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Gustavo's Wiki" aria-label="Search Gustavo's Wiki" autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://wiki.gustavozavaleta.com">Welcome</a></li><li class="breadcrumb-nav-list-item"><a href="https://wiki.gustavozavaleta.com/notes/9729bb5d-6c46-4422-bc01-0d4f1a9b3ef8.html">Programming</a></li><li class="breadcrumb-nav-list-item"><a href="https://wiki.gustavozavaleta.com/notes/ce6e9d6f-33bc-4eb6-aa8d-773740ff1a16.html">JavaScript</a></li><li class="breadcrumb-nav-list-item"><a href="https://wiki.gustavozavaleta.com/notes/dec2b4d3-ff94-4735-8797-0a65986de197.html">Node.js</a></li><li class="breadcrumb-nav-list-item">Profiling</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        
        

        

        

        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Profiling">
    
    <meta itemprop="datePublished" content="2021-05-22T13:30:34+00:00">
    <meta itemprop="dateModified" content="2021-05-22T13:34:34+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <h1 id="profiling"><a aria-hidden="true" class="anchor-heading" href="#profiling"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Profiling</h1>
<h2 id="motivation"><a aria-hidden="true" class="anchor-heading" href="#motivation"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Motivation</h2>
<p>We are planning to add new features to our application, will be good to have a "picture" for our api that can show how is the performance of our application today. A good advantage is to identify if future changes are affecting the current state of our application.</p>
<h2 id="some-apms-application-performance-management"><a aria-hidden="true" class="anchor-heading" href="#some-apms-application-performance-management"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Some APM's (Application Performance Management)</h2>
<ul>
<li>new relic</li>
<li>nsolid</li>
<li>datadog</li>
<li>sentry</li>
<li>raygun</li>
<li>scout</li>
</ul>
<h2 id="some-standard-profilers"><a aria-hidden="true" class="anchor-heading" href="#some-standard-profilers"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Some Standard Profilers</h2>
<ul>
<li>v8-profiler</li>
</ul>
<h2 id="other-visualization-profiling-tools"><a aria-hidden="true" class="anchor-heading" href="#other-visualization-profiling-tools"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Other visualization profiling tools</h2>
<p>Clinic-js</p>
<ul>
<li>Flame</li>
<li>bubleprof</li>
<li>doctor mem cpu</li>
</ul>
<h2 id="new-relic"><a aria-hidden="true" class="anchor-heading" href="#new-relic"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>New Relic</h2>
<h3 id="considerations"><a aria-hidden="true" class="anchor-heading" href="#considerations"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Considerations</h3>
<p>Only use versions supported LTS node</p>
<p>Node.js version Comments
6 - 10
Fully supported</p>
<p>11, 12
Not yet fully supported. See related GitHub documentation.</p>
<p>There are some frameworks available like express and restify that are supported.</p>
<h3 id="installation"><a aria-hidden="true" class="anchor-heading" href="#installation"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Installation</h3>
<p>Is really straigh fordward
<a href="https://docs.newrelic.com/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent">https://docs.newrelic.com/docs/agents/nodejs-agent/installation-configuration/install-nodejs-agent</a></p>
<h3 id="using-autocannon"><a aria-hidden="true" class="anchor-heading" href="#using-autocannon"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Using Autocannon</h3>
<p>npm i autocannon -g</p>
<p>sample:</p>
<pre class="language-bash"><code class="language-bash">autocannon -c <span class="token number">5</span> -d <span class="token number">99999</span> -t <span class="token number">20</span> -a <span class="token number">100</span> -b -i profiling/createbody.json -m POST -H <span class="token string">"Content-Type: application/json"</span> -H <span class="token string">"accesstoken: token"</span> http://localhost:3000/test
</code></pre>
<h3 id="test-1"><a aria-hidden="true" class="anchor-heading" href="#test-1"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Test 1</h3>
<pre class="language-bash"><code class="language-bash">
Stat <span class="token number">2.5</span>% <span class="token number">50</span>% <span class="token number">97.5</span>% <span class="token number">99</span>% Avg Stdev Max
Latency <span class="token number">14389</span> ms <span class="token number">17731</span> ms <span class="token number">33232</span> ms <span class="token number">33232</span> ms <span class="token number">19551.2</span> ms <span class="token number">4577.49</span> ms <span class="token number">33232.82</span> ms

Stat <span class="token number">1</span>% <span class="token number">2.5</span>% <span class="token number">50</span>% <span class="token number">97.5</span>% Avg Stdev Min
Req/Sec <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0.19</span> <span class="token number">0.4</span> <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B <span class="token number">0</span> B <span class="token number">319</span> B <span class="token number">60.6</span> B <span class="token number">125</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">30</span> requests <span class="token keyword">in</span> <span class="token number">158</span>.62s, <span class="token number">9.57</span> kB <span class="token builtin class-name">read</span>
<span class="token number">70</span> errors <span class="token punctuation">(</span><span class="token number">0</span> timeouts<span class="token punctuation">)</span>
</code></pre>
<p>and also reduce the parallel work from 5 concurrent connections to 4.</p>
<p>We had an anormaly using it, and the application shut down informing that we reach a heap size limit.</p>
<p><img src="./assets/images/2019-07-01-19-41-49.png" alt="first error"></p>
<p>We check on new relic</p>
<p><img src="./assets/images/2019-07-01-19-42-46.png" alt="ram"></p>
<p><img src="./assets/images/2019-07-01-19-43-07.png" alt="cpu"></p>
<p>We found the problem that was draining memory ram.</p>
<p><a href="https://git.autodesk.com/LYNX/hfdm-rest-api/blob/master/src/managers/HfdmManager.js#L161">https://git.autodesk.com/LYNX/hfdm-rest-api/blob/master/src/managers/HfdmManager.js#L161</a></p>
<p>The test seems to be working as expected.</p>
<p><img src="./assets/images/2019-07-01-19-54-13.png" alt="ram">
<img src="./assets/images/2019-07-01-19-54-25.png" alt="cpu"></p>
<h2 id="conclusions"><a aria-hidden="true" class="anchor-heading" href="#conclusions"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Conclusions</h2>
<p>Having an APM to give us feedback about our aplication, is really helpfull and almost necesary because it can show us wether the cpu, ram or the response time are increasing. Also what feature caused that and make desicions based on this information.</p>
<h2 id="profiling-with-clinicjs"><a aria-hidden="true" class="anchor-heading" href="#profiling-with-clinicjs"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Profiling with ClinicJS</h2>
<h3 id="flame"><a aria-hidden="true" class="anchor-heading" href="#flame"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Flame</h3>
<ul>
<li>The function on the bottom is the function on-CPU. The higher up the y-axis, the further nested the function.</li>
<li>The width of each function on the graph represents the amount of time it took that function to execute as a percentage of the total time of its parent function.</li>
<li>Finding functions that are both high on the y-axis (deeply nested) and wide on the x-axis (time-intensive) is a great way to narrow down performance and optimization issues</li>
</ul>
<pre class="language-bash"><code class="language-bash">Stat    <span class="token number">2.5</span>%    <span class="token number">50</span>%     <span class="token number">97.5</span>%    <span class="token number">99</span>%      Avg        Stdev     Max
Latency <span class="token number">4323</span> ms <span class="token number">5711</span> ms <span class="token number">10033</span> ms <span class="token number">10033</span> ms <span class="token number">5978.53</span> ms <span class="token number">1402.1</span> ms <span class="token number">10033.16</span> ms

Stat      <span class="token number">1</span>%  <span class="token number">2.5</span>% <span class="token number">50</span>%   <span class="token number">97.5</span>% Avg   Stdev Min
Req/Sec   <span class="token number">0</span>   <span class="token number">0</span>    <span class="token number">1</span>     <span class="token number">1</span>     <span class="token number">0.57</span>  <span class="token number">0.53</span>  <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B  <span class="token number">319</span> B <span class="token number">319</span> B <span class="token number">179</span> B <span class="token number">168</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">36</span> requests <span class="token keyword">in</span> <span class="token number">214</span>.65s, <span class="token number">11.5</span> kB <span class="token builtin class-name">read</span>
<span class="token number">4</span> errors <span class="token punctuation">(</span><span class="token number">4</span> timeouts<span class="token punctuation">)</span>
</code></pre>
<h4 id="conclusion"><a aria-hidden="true" class="anchor-heading" href="#conclusion"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Conclusion</h4>
<p>We can visualize CPU consumption and know is there is blocking code to take action about it.</p>
<h3 id="doctor"><a aria-hidden="true" class="anchor-heading" href="#doctor"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Doctor</h3>
<pre class="language-bash"><code class="language-bash">autocannon -c <span class="token number">4</span> -d <span class="token number">99999</span> -t <span class="token number">20</span> -a <span class="token number">40</span> -b -i profiling/createbody.json -m POST -H <span class="token string">"Content-Type: application/json"</span> -H <span class="token string">"accesstoken: token"</span> http://localhost:3000/test

Stat    <span class="token number">2.5</span>%    <span class="token number">50</span>%     <span class="token number">97.5</span>%   <span class="token number">99</span>%     Avg        Stdev     Max
Latency <span class="token number">4808</span> ms <span class="token number">5793</span> ms <span class="token number">7698</span> ms <span class="token number">8119</span> ms <span class="token number">5974.95</span> ms <span class="token number">753.55</span> ms <span class="token number">8119.16</span> ms

Stat      <span class="token number">1</span>%  <span class="token number">2.5</span>% <span class="token number">50</span>%   <span class="token number">97.5</span>% Avg   Stdev Min
Req/Sec   <span class="token number">0</span>   <span class="token number">0</span>    <span class="token number">1</span>     <span class="token number">2</span>     <span class="token number">0.65</span>  <span class="token number">0.65</span>  <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B  <span class="token number">319</span> B <span class="token number">638</span> B <span class="token number">206</span> B <span class="token number">207</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">40</span> requests <span class="token keyword">in</span> <span class="token number">62</span>.19s, <span class="token number">12.8</span> kB <span class="token builtin class-name">read</span>
</code></pre>
<h2 id="bubbleproof"><a aria-hidden="true" class="anchor-heading" href="#bubbleproof"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>bubbleproof</h2>
<pre class="language-bash"><code class="language-bash">
Stat    <span class="token number">2.5</span>%    <span class="token number">50</span>%     <span class="token number">97.5</span>%    <span class="token number">99</span>%      Avg         Stdev      Max
Latency <span class="token number">8586</span> ms <span class="token number">9699</span> ms <span class="token number">14819</span> ms <span class="token number">15510</span> ms <span class="token number">10453.68</span> ms <span class="token number">1595.08</span> ms <span class="token number">15510.06</span> ms

Stat      <span class="token number">1</span>%  <span class="token number">2.5</span>% <span class="token number">50</span>% <span class="token number">97.5</span>% Avg   Stdev Min
Req/Sec   <span class="token number">0</span>   <span class="token number">0</span>    <span class="token number">0</span>   <span class="token number">1</span>     <span class="token number">0.38</span>  <span class="token number">0.53</span>  <span class="token number">1</span>
Bytes/Sec <span class="token number">0</span> B <span class="token number">0</span> B  <span class="token number">0</span> B <span class="token number">319</span> B <span class="token number">120</span> B <span class="token number">167</span> B <span class="token number">319</span> B

Req/Bytes counts sampled once per second.

<span class="token number">40</span> requests <span class="token keyword">in</span> <span class="token number">106</span>.14s, <span class="token number">12.8</span> kB <span class="token builtin class-name">read</span>

autocannon -c <span class="token number">4</span> -d <span class="token number">99999</span> -t <span class="token number">20</span> -a <span class="token number">40</span> -b -i profiling/createbody.json -m POST -H <span class="token string">"Content-Type: application/json"</span> -H <span class="token string">"accesstoken: token"</span> http://localhost:3000/test
</code></pre><span id="navId" data="257957a2-5699-47d2-b6d5-96d468443db7"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>

        <div class="thumbs feedback_trigger right-bottom"></div>

        
          <hr>
          <footer>
            
            

            
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>

</body>
</html>
